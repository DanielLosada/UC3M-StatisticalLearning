---
title: "Assigment2.Rmd"
output: html_document
date: "2025-03-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data generation

```{r}
library(ggplot2)
library(mvtnorm)

Mu1 = c(1,1)
Mu2 = c(7,7)
Sigma1 = matrix(c(2, 1, 1, 1), 2,2)
Sigma2 = matrix(c(2, 2, 2, 5), 2,2)

pi = 1/3
n = 300

set.seed(2)
data = matrix(0, n, 2)
z = rep(0,n)
for (i in 1:n){
  z[i] = rbinom(1,1,pi)
  if (z[i] ==1){
    data[i,] = rmvnorm(1, Mu1,Sigma1)
  }else{
    data[i,] = rmvnorm(1, Mu2,Sigma2)
  }
}

to.plot = data.frame(x = data[,1], 
                  y = data[,2], 
                  class =  z)
ggplot(to.plot)+ aes(x, y, color = class)+
  geom_point()+geom_density_2d()
```


# EM Algorithm
```{r}
#initial values
tol = 10^-3
pi = 0.5
mu1 = data[1,]
mu2 = data[150,]
sigma1 = cov(data)
sigma2 = cov(data)

EM_algorithm <- function(data, pi, mu1, mu2, sigma1, sigma2, tol = 10^-2){
  
  phi1 = dmvnorm(data, mu1, sigma1) # φ1 en el pdf
  phi2 = dmvnorm(data, mu2, sigma2) # φ1 en el pdf
  
  L_temp = compute_l(pi, gamma, phi1, phi2)
  cat("Initial log-likelihood: ", L_temp, "\n")

  L <- 0
  iteration_counter <- 0
  
  while (abs(L-L_temp)>=tol) {
    L = L_temp
    # Expectation step
    gamma <- compute_gamma(pi, phi1, phi2)
    
    # Maximization step
    # mu1
    mu1 <- apply(gamma*data/sum(gamma), 2, sum)
    #mu2
    mu2 <- apply((1-gamma)*data/sum(1-gamma), 2, sum)
    # sigma1
    sigma1 <- cov.wt(data, wt = gamma, method = "ML")$cov
    # sigma2
    sigma2 <- cov.wt(data, wt = 1-gamma, method = "ML")$cov
    #pi
    pi <- mean(gamma)
    
    
    phi1 = dmvnorm(data, mu1, sigma1)
    phi2 = dmvnorm(data, mu2, sigma2)
    L_temp = compute_l(pi, gamma, phi1, phi2)
    iteration_counter <- iteration_counter + 1
    cat("Iteration: ", iteration_counter, " | Current log-likelihood: ", L_temp, "\n")
  }
  
  return(list(n_iterations=iteration_counter, pi=pi, mu1=mu1, mu2=mu2, sigma1=sigma1, sigma2=sigma2))
}

results <- EM_algorithm(data, pi, mu1, mu2, sigma1, sigma2, tol = tol)

cat("EM converged in ", results$n_iterations, " iterations.\n")

```

```{r}
results
```
```{r}

```

